<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØµØ­ÙŠØ­ ØµÙˆØ± Ø§Ù„ÙƒØªØ¨</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .book-item { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 4px; }
        .book-title { font-weight: bold; color: #2c3e50; }
        .path { font-family: monospace; background: #f8f9fa; padding: 5px; margin: 5px 0; border-radius: 3px; word-break: break-all; font-size: 12px; }
        .issues { color: #e74c3c; font-size: 0.9em; }
        .fixed { color: #27ae60; font-size: 0.9em; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .summary { background: #ecf0f1; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .summary-item { display: inline-block; margin: 5px 10px 5px 0; padding: 5px 10px; background: white; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØµØ­ÙŠØ­ ØµÙˆØ± Ø§Ù„ÙƒØªØ¨</h1>

        <div id="status" class="status" style="display: none;"></div>

        <div class="summary">
            <button onclick="analyzeBooks()">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØªØ¨</button>
            <button onclick="fixBooks()" id="fixBtn" disabled>ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„</button>
            <button onclick="testImage('uploads/books/covers/1767661296307-l1d3dp-884392723379.jpg')">ğŸ–¼ï¸ Ø§Ø®ØªØ¨Ø§Ø± ØµÙˆØ±Ø©</button>
            <button onclick="testFileExistence()">ğŸ” ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª</button>
            <button onclick="clearStatus()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
        </div>

        <div id="results"></div>

        <div class="summary">
            <h3>ğŸ“‹ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</h3>
            <ol>
                <li><strong>ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØªØ¨:</strong> Ù„Ø±Ø¤ÙŠØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                <li><strong>Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:</strong> Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                <li><strong>ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª:</strong> Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØµÙˆØ± ÙÙŠ B2</li>
                <li><strong>Ø§Ø®ØªØ¨Ø§Ø± ØµÙˆØ±Ø©:</strong> Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ API Ø§Ù„ØµÙˆØ±</li>
                <li><strong>Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„ÙƒØªØ¨</strong> Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬</li>
            </ol>
        </div>

        <div class="summary">
            <h3>ğŸ”§ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§:</h3>
            <div class="summary-item">URLs API Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</div>
            <div class="summary-item">Signed URLs Ù…Ù† B2</div>
            <div class="summary-item">Ù…Ø³Ø§Ø±Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
            <div class="summary-item">URLs Ù…ÙƒØ±Ø±Ø© Ø£Ùˆ Ù…Ø¹Ù‚Ø¯Ø©</div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';

            // Auto-hide after 8 seconds for success, keep errors visible
            if (type !== 'error') {
                setTimeout(() => {
                    if (statusEl.textContent === message) {
                        statusEl.style.display = 'none';
                    }
                }, 8000);
            }
        }

        function clearStatus() {
            document.getElementById('status').style.display = 'none';
        }

        async function analyzeBooks() {
            try {
                showStatus('Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØªØ¨... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø°Ù„Ùƒ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù', 'warning');

                const response = await fetch(`${API_BASE}/api/debug-books`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                displayResults(data);
                document.getElementById('fixBtn').disabled = data.summary.totalIssues === 0;

                if (data.summary.totalIssues === 0) {
                    showStatus('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ ØªØ¨Ø¯Ùˆ ØµØ­ÙŠØ­Ø©! Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„', 'success');
                } else {
                    showStatus(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.summary.totalIssues} Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ${data.totalBooks} ÙƒØªØ§Ø¨`, 'warning');
                }

            } catch (error) {
                console.error('Analyze error:', error);
                showStatus(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${error.message}. ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù„Ù‰ ${API_BASE}`, 'error');

                // Show troubleshooting tips
                document.getElementById('results').innerHTML = `
                    <div class="summary">
                        <h3>ğŸ” Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</h3>
                        <ul>
                            <li><strong>ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ø®Ø§Ø¯Ù…:</strong> <code>pnpm dev</code></li>
                            <li><strong>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†ÙØ°:</strong> ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3000</li>
                            <li><strong>ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©:</strong> Supabase URL Ùˆ Key</li>
                            <li><strong>Ø§ÙØªØ­ Developer Tools:</strong> F12 â†’ Console Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„</li>
                        </ul>
                        <p><strong>Ø§Ù„Ø®Ø·Ø£ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        async function fixBooks() {
            const confirmMessage = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©ØŸ\n\nØ³ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©.';
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showStatus('Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø°Ù„Ùƒ ÙˆÙ‚ØªØ§Ù‹', 'warning');
                document.getElementById('fixBtn').disabled = true;

                const response = await fetch(`${API_BASE}/api/debug-books`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                if (data.success) {
                    showStatus(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${data.fixedCount} ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰`, 'success');

                    // Re-analyze to show updated results
                    setTimeout(() => analyzeBooks(), 1000);
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­');
                }

            } catch (error) {
                console.error('Fix error:', error);
                showStatus(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ${error.message}`, 'error');
                document.getElementById('fixBtn').disabled = false;
            }
        }

        async function testImage(path) {
            if (!path) {
                path = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:', 'uploads/books/covers/1767661296307-l1d3dp-884392723379.jpg');
                if (!path) return;
            }

            try {
                showStatus(`Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©: ${path}`, 'info');

                const img = new Image();
                const testUrl = `${API_BASE}/api/download?key=${encodeURIComponent(path)}`;

                img.onload = () => {
                    showStatus(`âœ… Ø§Ù„ØµÙˆØ±Ø© ØªØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­: ${path.split('/').pop()}`, 'success');
                    console.log('Image loaded successfully:', testUrl);
                };

                img.onerror = (e) => {
                    showStatus(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: ${path.split('/').pop()}`, 'error');
                    console.error('Image failed to load:', testUrl, e);
                };

                // Set timeout for slow responses
                setTimeout(() => {
                    if (!img.complete) {
                        showStatus(`â±ï¸ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØµÙˆØ±Ø©: ${path.split('/').pop()}`, 'warning');
                    }
                }, 10000);

                img.src = testUrl;

            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©: ${error.message}`, 'error');
            }
        }

        async function testFileExistence() {
            try {
                showStatus('Ø¬Ø§Ø±ÙŠ ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ B2...', 'warning');

                // Get analysis first to get all file paths
                const analysisResponse = await fetch(`${API_BASE}/api/debug-books`);
                const analysisData = await analysisResponse.json();

                if (!analysisResponse.ok) {
                    throw new Error(analysisData.error);
                }

                let existingFiles = 0;
                let missingFiles = 0;
                const results = [];

                // Test each file
                for (const book of analysisData.analysis) {
                    if (book.cover_image_path && book.cover_image_path.startsWith('uploads/')) {
                        try {
                            const testResponse = await fetch(`${API_BASE}/api/debug-books`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ fileKey: book.cover_image_path })
                            });

                            const testData = await testResponse.json();

                            if (testData.exists) {
                                existingFiles++;
                                results.push({
                                    title: book.title,
                                    path: book.cover_image_path,
                                    status: 'Ù…ÙˆØ¬ÙˆØ¯',
                                    type: 'success'
                                });
                            } else {
                                missingFiles++;
                                results.push({
                                    title: book.title,
                                    path: book.cover_image_path,
                                    status: 'Ù…ÙÙ‚ÙˆØ¯',
                                    error: testData.error,
                                    type: 'error'
                                });
                            }
                        } catch (error) {
                            missingFiles++;
                            results.push({
                                title: book.title,
                                path: book.cover_image_path,
                                status: 'Ø®Ø·Ø£',
                                error: error.message,
                                type: 'error'
                            });
                        }
                    }
                }

                // Display results
                showStatus(`âœ… ØªÙ… ÙØ­Øµ ${results.length} Ù…Ù„Ù: ${existingFiles} Ù…ÙˆØ¬ÙˆØ¯, ${missingFiles} Ù…ÙÙ‚ÙˆØ¯`, 'info');

                const resultsDiv = document.getElementById('results');
                const fileTestSection = document.createElement('div');
                fileTestSection.className = 'summary';
                fileTestSection.innerHTML = `
                    <h3>ğŸ“ Ù†ØªØ§Ø¦Ø¬ ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ B2:</h3>
                    <div class="summary-item">Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: ${existingFiles}</div>
                    <div class="summary-item">Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©: ${missingFiles}</div>
                    <div class="summary-item">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª: ${results.length}</div>
                `;

                const fileList = document.createElement('div');
                fileList.style.maxHeight = '300px';
                fileList.style.overflowY = 'auto';
                fileList.style.marginTop = '10px';

                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'book-item';
                    item.style.borderLeft = result.type === 'success' ? '4px solid #27ae60' : '4px solid #e74c3c';
                    item.innerHTML = `
                        <div class="book-title">${result.title}</div>
                        <div class="path">${result.path}</div>
                        <div class="${result.type === 'success' ? 'fixed' : 'issues'}">Ø§Ù„Ø­Ø§Ù„Ø©: ${result.status}</div>
                        ${result.error ? `<div class="issues">Ø§Ù„Ø®Ø·Ø£: ${result.error}</div>` : ''}
                    `;
                    fileList.appendChild(item);
                });

                fileTestSection.appendChild(fileList);
                resultsDiv.appendChild(fileTestSection);

            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª: ${error.message}`, 'error');
                console.error('File existence test error:', error);
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // Summary
            const summary = document.createElement('div');
            summary.className = 'summary';
            summary.innerHTML = `
                <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„:</h3>
                <div class="summary-item">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØªØ¨: ${data.totalBooks}</div>
                <div class="summary-item">Ø§Ù„ÙƒØªØ¨ Ø°Ø§Øª Ø§Ù„Ù…Ø´Ø§ÙƒÙ„: ${data.summary.totalIssues}</div>
                <div class="summary-item">URLs API: ${data.summary.booksWithApiUrls}</div>
                <div class="summary-item">Signed URLs: ${data.summary.booksWithSignedUrls}</div>
                ${data.summary.totalIssues > 0 ?
                    '<div class="summary-item" style="background: #ffeaa7; color: #856404;">âš ï¸ ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­</div>' :
                    '<div class="summary-item" style="background: #d4edda; color: #155724;">âœ… Ø¬Ø§Ù‡Ø²</div>'}
            `;
            resultsDiv.appendChild(summary);

            if (data.analysis && data.analysis.length > 0) {
                // Book details
                const booksSection = document.createElement('div');
                booksSection.innerHTML = '<h3>ğŸ“š ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ¨:</h3>';

                data.analysis.forEach(book => {
                    const bookDiv = document.createElement('div');
                    bookDiv.className = 'book-item';

                    const issues = [];
                    if (book.issues.containsApiDownload) issues.push('URL API');
                    if (book.issues.looksLikeSignedUrl) issues.push('Signed URL');
                    if (book.issues.startsWithHttp && !book.issues.containsApiDownload && !book.issues.looksLikeSignedUrl) {
                        issues.push('HTTP URL');
                    }

                    const hasIssues = issues.length > 0;
                    const isFixed = book.recommendedFix === 'Path looks correct';

                    bookDiv.innerHTML = `
                        <div class="book-title">${book.title}</div>
                        <div class="path">${book.cover_image_path || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø±'}</div>
                        ${hasIssues ? `<div class="issues">Ø§Ù„Ù…Ø´Ø§ÙƒÙ„: ${issues.join(', ')}</div>` : ''}
                        ${!isFixed && book.recommendedFix !== 'No path' ? `<div class="fixed">Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${book.recommendedFix}</div>` : ''}
                        ${isFixed ? '<div class="fixed">âœ… Ø§Ù„Ù…Ø³Ø§Ø± ØµØ­ÙŠØ­</div>' : ''}
                    `;

                    booksSection.appendChild(bookDiv);
                });

                resultsDiv.appendChild(booksSection);
            }

            // Instructions
            const instructions = document.createElement('div');
            instructions.className = 'summary';
            instructions.innerHTML = `
                <h3>ğŸš€ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</h3>
                <ol>
                    <li>Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ù…Ø´Ø§ÙƒÙ„ØŒ Ø§Ø¶ØºØ· <strong>"Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„"</strong></li>
                    <li>Ø§Ù†ØªØ¸Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯</li>
                    <li>Ø§Ø¶ØºØ· <strong>"ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØªØ¨"</strong> Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ØªØ­Ù‚Ù‚</li>
                    <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ <a href="/books" target="_blank">ØµÙØ­Ø© Ø§Ù„ÙƒØªØ¨</a> Ù„ØªØ±Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</li>
                </ol>
            `;
            resultsDiv.appendChild(instructions);
        }

        // Auto-analyze on load
        console.log('ğŸ”§ Debug Books Tool Loaded');
        console.log('ğŸŒ API Base:', API_BASE);
        console.log('ğŸ“ Use analyzeBooks() to start analysis');

        // Show welcome message
        showStatus('âœ… Ø£Ø¯Ø§Ø© Ø§Ù„ØªØµØ­ÙŠØ­ Ø¬Ø§Ù‡Ø²Ø©! Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØªØ¨" Ù„Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ', 'info');
    </script>
</body>
</html>
